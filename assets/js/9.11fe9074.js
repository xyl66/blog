(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{356:function(t,a,e){"use strict";e.r(a);var s=e(42),n=Object(s.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"web性能监控"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#web性能监控"}},[t._v("#")]),t._v(" web性能监控")]),t._v(" "),e("blockquote",[e("p",[t._v("文章转载自: AlloyTeam：http://www.alloyteam.com/2020/01/14184/\n作者: liu, summerqy")])]),t._v(" "),e("p",[t._v("也许你有听过一个问题，你这款 web 应用性能怎么样呀？你会回答什么呢？是否会优于海量 web 应用市场呢？本文就来整理下如何进行 web 性能监控？包括我们需要监控的指标、监控的分类、performance 分析以及如何监控。")]),t._v(" "),e("p",[t._v("但是，如何进行 web 性能监控本身是一个很大的话题，文中只会侧重一部分进行研究，某些内容不是很全面。")]),t._v(" "),e("h2",{attrs:{id:"前言：为什么需要监控？"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#前言：为什么需要监控？"}},[t._v("#")]),t._v(" 前言：为什么需要监控？")]),t._v(" "),e("p",[t._v("web 的性能一定程度上影响了用户留存率，Google DoubleClick 研究表明：如果一个移动端页面加载时长超过 3 秒，用户就会放弃而离开。BBC 发现网页加载时长每增加 1 秒，用户就会流失 10%。")]),t._v(" "),e("p",[t._v("我们希望通过监控来知道 web 应用性能的现状和趋势，找到 web 应用的瓶颈？某次发布后的性能情况怎么样？是否发布后对性能有影响？感知到业务出错的概率？业务的稳定性怎么样？")]),t._v(" "),e("h2",{attrs:{id:"监控什么？"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#监控什么？"}},[t._v("#")]),t._v(" 监控什么？")]),t._v(" "),e("p",[t._v("首先我们需要知道应该监控些什么呢？有哪些具体的指标？")]),t._v(" "),e("p",[t._v("google 开发者提出了一种 RAIL 模型来衡量应用性能，即：Response、Animation、Idle、Load，分别代表着 web 应用生命周期的四个不同方面。并指出最好的性能指标是：100ms 内响应用户输入；动画或者滚动需在 10ms 内产生下一帧；最大化空闲时间；页面加载时长不超过 5 秒。")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah4zxc779j314w0u07bg.jpg",alt:"图片"}}),t._v("\n我们可转化为三个方面来看：响应速度、页面稳定性、外部服务调用")]),t._v(" "),e("ul",[e("li",[t._v("响应速度：页面初始访问速度 + 交互响应速度")]),t._v(" "),e("li",[t._v("页面稳定性：页面出错率")]),t._v(" "),e("li",[t._v("外部服务调用：网络请求访问速度")])]),t._v(" "),e("h3",{attrs:{id:"_1-页面访问速度：白屏、首屏时间、可交互时间"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-页面访问速度：白屏、首屏时间、可交互时间"}},[t._v("#")]),t._v(" 1.页面访问速度：白屏、首屏时间、可交互时间")]),t._v(" "),e("p",[t._v("我们来看看 google 开发者针对用户体验，提出的几个性能指标\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah51k3lg8j31bi0gg45d.jpg",alt:"图片"}})]),t._v(" "),e("p",[t._v("这几个指标其实都是根据用户体验，提炼出对应的性能指标\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah52b9pkrj30v00bwabn.jpg",alt:"图片"}})]),t._v(" "),e("h4",{attrs:{id:"_1）first-paint-fp-and-first-contentful-paint-fcp"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1）first-paint-fp-and-first-contentful-paint-fcp"}},[t._v("#")]),t._v(" 1）first paint (FP) and first contentful paint (FCP)")]),t._v(" "),e("p",[t._v("首次渲染、首次有内容的渲染")]),t._v(" "),e("p",[t._v("这两个指标浏览器已经标准化了，从 performance 的 The Paint Timing API 可以获取到，一般来说两个时间相同，但也有情况下两者不同。\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah52tov3jj30pa0gagod.jpg",alt:"图片"}})]),t._v(" "),e("h4",{attrs:{id:"_2）first-meaningful-paint-and-hero-element-timing"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2）first-meaningful-paint-and-hero-element-timing"}},[t._v("#")]),t._v(" 2）First meaningful paint and hero element timing")]),t._v(" "),e("p",[t._v("首次有意义的渲染、页面关键元素")]),t._v(" "),e("p",[t._v("我们假设当一个网页的 DOM 结构发生剧烈的变化的时候，就是这个网页主要内容出现的时候，那么在这样的一个时间点上，就是首次有意义的渲染。这个指标浏览器还没有规范，毕竟很难统一一个标准来定义网站的主体内容。")]),t._v(" "),e("p",[t._v("google lighthouse 定义的 first meaningful paint：https://docs.google.com/document/d/1BR94tJdZLsin5poeet0XoTW60M0SjvOJQttKT-JK8HI/view")]),t._v(" "),e("h4",{attrs:{id:"_3）time-to-interactive"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3）time-to-interactive"}},[t._v("#")]),t._v(" 3）Time to interactive")]),t._v(" "),e("p",[t._v("可交互时间")]),t._v(" "),e("h4",{attrs:{id:"_4）长任务"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4）长任务"}},[t._v("#")]),t._v(" 4）长任务")]),t._v(" "),e("p",[t._v("浏览器是单线程的，如果长任务过多，那必然会影响着用户响应时长。好的应用需要最大化空闲时间，以保证能最快响应用户的输入。\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah53416gmj31bg0kgn9i.jpg",alt:"图片"}})]),t._v(" "),e("h3",{attrs:{id:"_2-页面稳定性：页面出错情况"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-页面稳定性：页面出错情况"}},[t._v("#")]),t._v(" 2.页面稳定性：页面出错情况")]),t._v(" "),e("ul",[e("li",[t._v("资源加载错误")]),t._v(" "),e("li",[t._v("JS 执行报错")])]),t._v(" "),e("h3",{attrs:{id:"_3-外部服务调用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-外部服务调用"}},[t._v("#")]),t._v(" 3.外部服务调用")]),t._v(" "),e("ul",[e("li",[t._v("CGI 耗时")]),t._v(" "),e("li",[t._v("CGI 成功率")]),t._v(" "),e("li",[t._v("CDN 资源耗时")])]),t._v(" "),e("h2",{attrs:{id:"监控的分类？"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#监控的分类？"}},[t._v("#")]),t._v(" 监控的分类？")]),t._v(" "),e("p",[t._v("web 性能监控可分为两类，一类是合成监控（Synthetic Monitoring，SYN），另一类是真实用户监控（Real User Monitoring，RUM）")]),t._v(" "),e("h3",{attrs:{id:"合成监控"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#合成监控"}},[t._v("#")]),t._v(" 合成监控")]),t._v(" "),e("p",[t._v("合成监控是采用 web 浏览器模拟器来加载网页，通过模拟终端用户可能的操作来采集对应的性能指标，最后输出一个网站性能报告。例如："),e("code",[t._v("Lighthouse")]),t._v("、"),e("code",[t._v("PageSpeed")]),t._v("、"),e("code",[t._v("WebPageTest")]),t._v("、"),e("code",[t._v("Pingdom")]),t._v("、"),e("code",[t._v("PhantomJS")]),t._v(" 等。")]),t._v(" "),e("h4",{attrs:{id:"_1-lighthouse"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-lighthouse"}},[t._v("#")]),t._v(" 1. Lighthouse")]),t._v(" "),e("p",[e("code",[t._v("Lighthouse")]),t._v(" 是 google 一个开源的自动化工具，运行 "),e("code",[t._v("Lighthouse")]),t._v(" 的方式有两种：一种是作为 Chrome 扩展程序运行；另一种作为命令行工具运行。Chrome 扩展程序提供了一个对用户更友好的界面，方便读取报告。通过命令行工具可以将 "),e("code",[t._v("Lighthouse")]),t._v(" 集成到持续集成系统。")]),t._v(" "),e("p",[t._v("展示了白屏、首屏、可交互时间等性能指标和 SEO、PWA 等。")]),t._v(" "),e("p",[t._v("腾讯文档移动端官网首页测速结果：\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah53h9fohj30u01d37fc.jpg",alt:"图片"}})]),t._v(" "),e("h4",{attrs:{id:"_2-pagespeed"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-pagespeed"}},[t._v("#")]),t._v(" 2. PageSpeed")]),t._v(" "),e("p",[t._v("https://developers.google.com/speed/pagespeed/insights/")]),t._v(" "),e("p",[t._v("不仅展示了一些主要的性能指标数据，还给出了部分性能优化建议。")]),t._v(" "),e("p",[t._v("腾讯文档移动端首页测速结果和性能优化建议：\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah53rtaaij30u01b4n8n.jpg",alt:"图片"}})]),t._v(" "),e("h4",{attrs:{id:"_3-webpagetest"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-webpagetest"}},[t._v("#")]),t._v(" 3. WebPageTest")]),t._v(" "),e("p",[t._v("WebPageTest")]),t._v(" "),e("p",[t._v("给出性能测速结果和资源加载的瀑布图。\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah546pqeij30vw0u0wv2.jpg",alt:"图片"}})]),t._v(" "),e("h4",{attrs:{id:"_4-pingdom"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-pingdom"}},[t._v("#")]),t._v(" 4. Pingdom")]),t._v(" "),e("p",[t._v("https://www.pingdom.com/")]),t._v(" "),e("p",[t._v("注意：Pingdom 不仅提供合成监控，也提供真实用户监控。\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah54gtu29j311d0u0tie.jpg",alt:"图片"}})]),t._v(" "),e("p",[t._v("合成监控方式的优缺点：")]),t._v(" "),e("p",[t._v("优点：")]),t._v(" "),e("ul",[e("li",[t._v("无侵入性。")]),t._v(" "),e("li",[t._v("简单快捷。缺点：")]),t._v(" "),e("li",[t._v("不是真实的用户访问情况，只是模拟的。")]),t._v(" "),e("li",[t._v("没法考虑到登录的情况，对于需要登录的页面就无法监控到。")])]),t._v(" "),e("h3",{attrs:{id:"二、真实用户监控"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二、真实用户监控"}},[t._v("#")]),t._v(" 二、真实用户监控")]),t._v(" "),e("p",[t._v("真实用户监控是一种被动监控技术，是一种应用服务，被监控的 web 应用通过 sdk 等方式接入该服务，将真实的用户访问、交互等性能指标数据收集上报、通过数据清洗加工后形成性能分析报表。例如 "),e("code",[t._v("FrontJs")]),t._v("、"),e("code",[t._v("oneapm")]),t._v("、"),e("code",[t._v("Datadog")]),t._v(" 等。\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah55go4uwj31mq0b2q50.jpg",alt:"图片"}})]),t._v(" "),e("h4",{attrs:{id:"_1-oneapm"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-oneapm"}},[t._v("#")]),t._v(" 1. oneapm")]),t._v(" "),e("p",[t._v("https://www.oneapm.com/bi/feature.html")]),t._v(" "),e("p",[t._v("功能包括：大盘数据、特征统计、慢加载追踪、访问页面、脚本错误、AJAX、组合分析、报表、告警等。\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah5546jc8j31vd0u07nj.jpg",alt:"图片"}})]),t._v(" "),e("h5",{attrs:{id:"_2-datadog"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-datadog"}},[t._v("#")]),t._v(" 2. Datadog")]),t._v(" "),e("p",[t._v("https://www.datadoghq.com/rum/\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah55pv17yj31gf0u0x5y.jpg",alt:"图片"}})]),t._v(" "),e("h4",{attrs:{id:"_3-frontjs"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-frontjs"}},[t._v("#")]),t._v(" 3. FrontJs")]),t._v(" "),e("p",[t._v("https://www.frontjs.com/")]),t._v(" "),e("p",[t._v("功能包括：访问性能、异常监控、报表、趋势等。\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah55yona3j31sy0u01ff.jpg",alt:"图片"}})]),t._v(" "),e("p",[t._v("这种监控方式的优缺点：")]),t._v(" "),e("p",[t._v("优点：")]),t._v(" "),e("ul",[e("li",[t._v("是真实用户访问情况。\n可以观察历史性能趋势。")]),t._v(" "),e("li",[t._v("有一些额外的功能：报表推送、监控告警等等。缺点：")]),t._v(" "),e("li",[t._v("有侵入性，会一定程度上响应 web 性能。")])]),t._v(" "),e("h2",{attrs:{id:"performance-分析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#performance-分析"}},[t._v("#")]),t._v(" performance 分析")]),t._v(" "),e("p",[t._v("在讲如何监控之前，先来看看浏览器提供的 performance api，这也是性能监控数据的主要来源。")]),t._v(" "),e("p",[t._v("performance 提供高精度的时间戳，精度可达纳秒级别，且不会随操作系统时间设置的影响。")]),t._v(" "),e("p",[t._v("目前市场上的支持情况：主流浏览器都支持，大可放心使用。\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah5ba37dfj31yo0hq42c.jpg",alt:"图片"}})]),t._v(" "),e("h3",{attrs:{id:"基本属性"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#基本属性"}},[t._v("#")]),t._v(" 基本属性")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah5be2ewkj31tg092n0v.jpg",alt:"图片"}})]),t._v(" "),e("p",[t._v("performance.navigation: 页面是加载还是刷新、发生了多少次重定向\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah5bnvq8mj30ne05ijs4.jpg",alt:"图片"}})]),t._v(" "),e("p",[t._v("performance.timing: 页面加载的各阶段时长\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah5bwyq4mj30mg0o0wjy.jpg",alt:"图片"}})]),t._v(" "),e("p",[t._v("各阶段的含义：\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah5cm2r73j31g20u0x6r.jpg",alt:"图片"}})]),t._v(" "),e("p",[t._v("performance.memory：基本内存使用情况，Chrome 添加的一个非标准扩展\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah5cbazibj315q06eq4i.jpg",alt:"图片"}})]),t._v(" "),e("p",[t._v("performance.timeorigin: 性能测量开始时的时间的高精度时间戳\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah5cviad6j30dm026mx8.jpg",alt:"图片"}})]),t._v(" "),e("h3",{attrs:{id:"基本方法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#基本方法"}},[t._v("#")]),t._v(" 基本方法")]),t._v(" "),e("ul",[e("li",[e("code",[t._v("performance.getEntries()")])])]),t._v(" "),e("p",[t._v("通过这个方法可以获取到所有的 "),e("code",[t._v("performance")]),t._v(" 实体对象，通过 "),e("code",[t._v("getEntriesByName")]),t._v(" 和 "),e("code",[t._v("getEntriesByType")]),t._v(" 方法可对所有的 "),e("code",[t._v("performance")]),t._v(" 实体对象 进行过滤，返回特定类型的实体。")]),t._v(" "),e("p",[e("code",[t._v("mark")]),t._v(" 方法 和 "),e("code",[t._v("measure")]),t._v(" 方法的结合可打点计时，获取某个函数执行耗时等。\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah5dbnjlej31nq0u01es.jpg",alt:"图片"}})]),t._v(" "),e("ul",[e("li",[e("code",[t._v("performance.getEntriesByName()")])]),t._v(" "),e("li",[e("code",[t._v("performance.getEntriesByType()")])]),t._v(" "),e("li",[e("code",[t._v("performance.mark()")])]),t._v(" "),e("li",[e("code",[t._v("performance.clearMarks()")])]),t._v(" "),e("li",[e("code",[t._v("performance.measure()")])]),t._v(" "),e("li",[e("code",[t._v("performance.clearMeasures()")])]),t._v(" "),e("li",[e("code",[t._v("performance.now()")]),t._v("...")])]),t._v(" "),e("h3",{attrs:{id:"提供的-api"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#提供的-api"}},[t._v("#")]),t._v(" 提供的 API")]),t._v(" "),e("p",[t._v("performance 也提供了多种 API，不同的 API 之间可能会有重叠的部分。")]),t._v(" "),e("h4",{attrs:{id:"_1-performanceobserver-api"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-performanceobserver-api"}},[t._v("#")]),t._v(" 1. PerformanceObserver API")]),t._v(" "),e("p",[t._v("用于检测性能的事件，这个 API 利用了观察者模式。")]),t._v(" "),e("p",[t._v("获取资源信息\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah5dyhhrtj31g40liq6s.jpg",alt:"图片"}}),t._v("\n监测 TTI\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah5e76hzhj30yq0bsgna.jpg",alt:"图片"}})]),t._v(" "),e("p",[t._v("监测 长任务\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah5f4cbcsj30uo0dk76r.jpg",alt:"图片"}})]),t._v(" "),e("h4",{attrs:{id:"_2-navigation-timing-api"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-navigation-timing-api"}},[t._v("#")]),t._v(" 2. Navigation Timing API")]),t._v(" "),e("p",[t._v("https://www.w3.org/TR/navigation-timing-2/")]),t._v(" "),e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v("performance"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getEntriesByType")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"navigation"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah5foxbyej30u011ath3.jpg",alt:"图片"}}),t._v(" "),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah5g41v1jj318o0dugnt.jpg",alt:"图片"}})]),t._v(" "),e("p",[t._v("不同阶段之间是连续的吗? —— 不连续")]),t._v(" "),e("p",[t._v("每个阶段都一定会发生吗？—— 不一定")]),t._v(" "),e("ul",[e("li",[t._v("重定向次数：performance.navigation.redirectCount")]),t._v(" "),e("li",[t._v("重定向耗时: redirectEnd - redirectStart")]),t._v(" "),e("li",[t._v("DNS 解析耗时: domainLookupEnd - domainLookupStart")]),t._v(" "),e("li",[t._v("TCP 连接耗时: connectEnd - connectStart")]),t._v(" "),e("li",[t._v("SSL 安全连接耗时: connectEnd - secureConnectionStart")]),t._v(" "),e("li",[t._v("网络请求耗时 (TTFB): responseStart - requestStart")]),t._v(" "),e("li",[t._v("数据传输耗时: responseEnd - responseStart")]),t._v(" "),e("li",[t._v("DOM 解析耗时: domInteractive - responseEnd")]),t._v(" "),e("li",[t._v("资源加载耗时: loadEventStart - domContentLoadedEventEnd")]),t._v(" "),e("li",[t._v("首包时间: responseStart - domainLookupStart")]),t._v(" "),e("li",[t._v("白屏时间: domloading/dominteractive - fetchStart")]),t._v(" "),e("li",[t._v("首次可交互时间: domInteractive - fetchStart")]),t._v(" "),e("li",[t._v("DOM Ready 时间: domContentLoadEventEnd - fetchStart")]),t._v(" "),e("li",[t._v("页面完全加载时间: loadEventStart - fetchStart")]),t._v(" "),e("li",[t._v("http 头部大小：transferSize - encodedBodySize")])]),t._v(" "),e("h4",{attrs:{id:"_3-resource-timing-api"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-resource-timing-api"}},[t._v("#")]),t._v(" 3. Resource Timing API")]),t._v(" "),e("p",[t._v("https://w3c.github.io/resource-timing/")]),t._v(" "),e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v("performance"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getEntriesByType")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"resource"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah5gxga20j31as0u01kx.jpg",alt:"图片"}}),t._v(" "),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah5h63g05j31c60le0w9.jpg",alt:"图片"}})]),t._v(" "),e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 某类资源的加载时间，可测量图片、js、css、XHR")]),t._v("\nresourceListEntries"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("forEach")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resource")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("resource"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("initiatorType "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'img'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("info")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token template-string"}},[e("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("Time taken to load ")]),e("span",{pre:!0,attrs:{class:"token interpolation"}},[e("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("resource"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),e("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v(": ")]),e("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" resource"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("responseEnd "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" resource"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("startTime"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br")])]),e("p",[t._v("这个数据和 chrome 调式工具里 network 的瀑布图数据是一样的。")]),t._v(" "),e("h4",{attrs:{id:"_4-paint-timing-api"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-paint-timing-api"}},[t._v("#")]),t._v(" 4. paint Timing API")]),t._v(" "),e("p",[t._v("https://w3c.github.io/paint-timing/")]),t._v(" "),e("p",[t._v("首屏渲染时间(FP)、首次有内容渲染时间(FCP)\n"),e("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwgy1gah5inwonkj30rq0g4acu.jpg",alt:"图片"}})]),t._v(" "),e("h4",{attrs:{id:"_5-user-timing-api"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-user-timing-api"}},[t._v("#")]),t._v(" 5. User Timing API")]),t._v(" "),e("p",[t._v("https://www.w3.org/TR/user-timing-2/#introduction\n主要是利用 mark 和 measure 方法去打点计算某个阶段的耗时，例如某个函数的耗时等。")]),t._v(" "),e("h4",{attrs:{id:"_6-high-resolution-time-api"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-high-resolution-time-api"}},[t._v("#")]),t._v(" 6. High Resolution Time API")]),t._v(" "),e("p",[t._v("https://w3c.github.io/hr-time/#dom-performance-timeorigin")]),t._v(" "),e("p",[t._v("主要包括 now() 方法和 timeOrigin 属性。")]),t._v(" "),e("h4",{attrs:{id:"_7-performance-timeline-api"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-performance-timeline-api"}},[t._v("#")]),t._v(" 7. Performance Timeline API")]),t._v(" "),e("p",[t._v("https://www.w3.org/TR/performance-timeline-2/#introduction")]),t._v(" "),e("h3",{attrs:{id:"总结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),e("h4",{attrs:{id:"基于-performance-我们可以测量如下几个方面："}},[e("a",{staticClass:"header-anchor",attrs:{href:"#基于-performance-我们可以测量如下几个方面："}},[t._v("#")]),t._v(" 基于 performance 我们可以测量如下几个方面：")]),t._v(" "),e("p",[t._v("mark、measure、navigation、resource、paint、frame。")]),t._v(" "),e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" p "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" window"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("performance"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getEntries")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("p",[t._v("重定向次数："),e("code",[t._v("performance.navigation.redirectCount")])]),t._v(" "),e("p",[t._v("JS 资源数量: "),e("code",[t._v('p.filter(ele => ele.initiatorType === "script").length')])]),t._v(" "),e("p",[t._v("CSS 资源数量："),e("code",[t._v('p.filter(ele => ele.initiatorType === "css").length')])]),t._v(" "),e("p",[t._v("AJAX 请求数量："),e("code",[t._v('p.filter(ele => ele.initiatorType === "xmlhttprequest").length')])]),t._v(" "),e("p",[t._v("IMG 资源数量："),e("code",[t._v('p.filter(ele => ele.initiatorType === "img").length')])]),t._v(" "),e("p",[t._v("总资源数量: "),e("code",[t._v('window.performance.getEntriesByType("resource").length')])]),t._v(" "),e("h4",{attrs:{id:"不重复的耗时时段区分："}},[e("a",{staticClass:"header-anchor",attrs:{href:"#不重复的耗时时段区分："}},[t._v("#")]),t._v(" 不重复的耗时时段区分：")]),t._v(" "),e("p",[t._v("重定向耗时: redirectEnd - redirectStart")]),t._v(" "),e("p",[t._v("DNS 解析耗时: domainLookupEnd - domainLookupStart")]),t._v(" "),e("p",[t._v("TCP 连接耗时: connectEnd - connectStart")]),t._v(" "),e("p",[t._v("SSL 安全连接耗时: connectEnd - secureConnectionStart")]),t._v(" "),e("p",[t._v("网络请求耗时 (TTFB): responseStart - requestStart")]),t._v(" "),e("p",[t._v("HTML 下载耗时：responseEnd - responseStart")]),t._v(" "),e("p",[t._v("DOM 解析耗时: domInteractive - responseEnd")]),t._v(" "),e("p",[t._v("资源加载耗时: loadEventStart - domContentLoadedEventEnd")]),t._v(" "),e("h4",{attrs:{id:"其他组合分析："}},[e("a",{staticClass:"header-anchor",attrs:{href:"#其他组合分析："}},[t._v("#")]),t._v(" 其他组合分析：")]),t._v(" "),e("p",[t._v("白屏时间: domLoading - fetchStart")]),t._v(" "),e("p",[t._v("粗略首屏时间: loadEventEnd - fetchStart 或者 domInteractive - fetchStart")]),t._v(" "),e("p",[t._v("DOM Ready 时间: domContentLoadEventEnd - fetchStart")]),t._v(" "),e("p",[t._v("页面完全加载时间: loadEventStart - fetchStart")]),t._v(" "),e("h4",{attrs:{id:"js-总加载耗时"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#js-总加载耗时"}},[t._v("#")]),t._v(" JS 总加载耗时:")]),t._v(" "),e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" p "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" window"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("performance"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getEntries")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" cssR "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" p"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("filter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ele")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" ele"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("initiatorType "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"script"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nMath"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("max")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("cssR"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("map")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ele")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" ele"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("responseEnd"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" Math"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("min")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("cssR"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("map")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ele")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" ele"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("startTime"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br")])]),e("h4",{attrs:{id:"css-总加载耗时"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#css-总加载耗时"}},[t._v("#")]),t._v(" CSS 总加载耗时:")]),t._v(" "),e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" p "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" window"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("performance"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getEntries")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" cssR "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" p"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("filter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ele")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" ele"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("initiatorType "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"css"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nMath"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("max")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("cssR"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("map")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ele")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" ele"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("responseEnd"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" Math"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("min")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("cssR"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("map")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ele")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" ele"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("startTime"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br")])]),e("h2",{attrs:{id:"如何监控？"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#如何监控？"}},[t._v("#")]),t._v(" 如何监控？")]),t._v(" "),e("p",[t._v("在了解了 performance 之后，我们来看看，具体是如何监控的？\n"),e("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_jpg/YBFV3Da0NwsKDJJUkJTEwLBWnTCxr1TrzAY9KbXZ8lt4q6jSHk6NtIR840OlS2JpQNyDFLZqGDW8xDeKXTxFIg/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),t._v("\n总体流程：性能指标收集与数据上报—数据存储—数据聚合—分析展示—告警、报表推送")]),t._v(" "),e("p",[t._v("这里主要讲述如何收集性能数据。")]),t._v(" "),e("p",[t._v("性能指标收集注意项：")]),t._v(" "),e("ul",[e("li",[t._v("保证数据的准确性")]),t._v(" "),e("li",[t._v("尽量不影响应用的性能")])]),t._v(" "),e("h3",{attrs:{id:"_1-基本性能上报"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-基本性能上报"}},[t._v("#")]),t._v(" 1.基本性能上报")]),t._v(" "),e("p",[t._v("采集数据：将"),e("code",[t._v("performance navagation timing")]),t._v(" 中的所有点都上报，其余的上报内容可参考 "),e("code",[t._v("performance")]),t._v(" 分析一节中截取部分上报。例如：白屏时间，"),e("code",[t._v("JS")]),t._v(" 和 "),e("code",[t._v("CSS")]),t._v(" 总数，以及加载总时长。")]),t._v(" "),e("p",[t._v("其余可参考的上报：是否有缓存？是否启用 "),e("code",[t._v("gzip")]),t._v(" 压缩、页面加载方式。在收集好性能数据后，即可将数据上报。")]),t._v(" "),e("p",[t._v("那选择什么时机上报？")]),t._v(" "),e("p",[t._v("google 开发者推荐的上报方式：\n"),e("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_jpg/YBFV3Da0NwsKDJJUkJTEwLBWnTCxr1TrQFR3oVfxMpgjt1Q4oWJbLTp3CHEVHVrick7hHrybw01GrSCKSuOaUiaw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),t._v(" "),e("h3",{attrs:{id:"_2-首屏时间计算"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-首屏时间计算"}},[t._v("#")]),t._v(" 2.首屏时间计算")]),t._v(" "),e("p",[t._v("我们知道首屏时间是一项重要指标，但是又很难从 performance 中拿到，来看下首屏时间计算主要有哪些方式？")]),t._v(" "),e("p",[t._v("https://web.dev/first-meaningful-paint/")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("用户自定义打点—最准确的方式（只有用户自己最清楚，什么样的时间才算是首屏加载完成）")])]),t._v(" "),e("li",[e("p",[t._v("lighthouse 中使用的是 chrome 渲染过程中记录的 trace event")])]),t._v(" "),e("li",[e("p",[t._v("可利用 Chrome DevTools Protocol 拿到页面布局节点数目。思想是：获取到当页面具有最大布局变化的时间点")])]),t._v(" "),e("li",[e("p",[t._v("aegis 的方法：利用 MutationObserver 接口，监听 document 对象的节点变化。")]),t._v(" "),e("p",[t._v("检查这些变化的节点是否显示在首屏中，若这些节点在首屏中，那当前的时间点即为首屏渲染时间。但是还有首屏内图片的加载时间需要考虑，遍历 "),e("code",[t._v("performance.getEntries()")]),t._v(" 拿到的所有图片实体对象，根据图片的初始加载时间和加载完成时间去更新首屏渲染时间。")])]),t._v(" "),e("li",[e("p",[t._v("利用MutationObserver 接口提供了监视对 DOM 树所做更改的能力，是 DOM3 Events 规范的一部分。")]),t._v(" "),e("p",[t._v("方法：在首屏内容模块插入一个 div，利用 Mutation Observer API 监听该 div 的 dom 事件，判断该 div 的高度是否大于 0 或者大于指定值，如果大于了，就表示主要内容已经渲染出来，可计算首屏时间。")])]),t._v(" "),e("li",[e("p",[t._v("某个专利：在 loading 状态下循环判断当前页面高度是否大于屏幕高度，若大于，则获取到当前页面的屏幕图像，通过逐像素对比来判断页面渲染是否已满屏。\n"),e("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_jpg/YBFV3Da0NwsKDJJUkJTEwLBWnTCxr1Trbo61VJNzdlw7JsUicibuvVUL6mmaibicYZDibF8LbcWXKOpKYdQnZHN2mzQ/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})])])]),t._v(" "),e("h3",{attrs:{id:"_3-异常上报"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-异常上报"}},[t._v("#")]),t._v(" 3.异常上报")]),t._v(" "),e("ul",[e("li",[t._v("1）js error监听 window.onerror 事件")]),t._v(" "),e("li",[t._v("2）promise reject 的异常监听 unhandledrejection 事件"),e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v("window"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("addEventListener")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"unhandledrejection"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("event")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("warn")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"WARNING: Unhandled promise rejection. Shame on you! Reason: "')]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" event"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("reason"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br")])])]),t._v(" "),e("li",[t._v("3）资源加载失败window.addEventListener('error')")]),t._v(" "),e("li",[t._v("4）网络请求失败重写 window.XMLHttpRequest 和 window.fetch 捕获请求错误")]),t._v(" "),e("li",[t._v("5）iframe 异常window.frames[0].onerror")]),t._v(" "),e("li",[t._v("6）window.console.error")])]),t._v(" "),e("h3",{attrs:{id:"_4-cgi-上报"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-cgi-上报"}},[t._v("#")]),t._v(" 4.CGI 上报")]),t._v(" "),e("p",[t._v("大致原理：拦截 ajax 请求")]),t._v(" "),e("p",[t._v("数据存储与聚合")]),t._v(" "),e("p",[t._v("一个用户访问，可能会上报几十条数据，每条数据都是多维度的。即：当前访问时间、平台、网络、ip 等。这些一条条的数据都会被存储到数据库中，然后通过数据分析与聚合，提炼出有意义的数据。例如：某日所有用户的平均访问时长、pv 等。")]),t._v(" "),e("p",[t._v("数据统计分析的方法：平均值统计法、百分位数统计法、样本分布统计法。")]),t._v(" "),e("h2",{attrs:{id:"参考文章"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考文章"}},[t._v("#")]),t._v(" 参考文章")]),t._v(" "),e("ul",[e("li",[e("p",[e("a",{attrs:{href:"https://developers.google.cn/web/fundamentals/performance/why-performance-matters",target:"_blank",rel:"noopener noreferrer"}},[t._v("为什么性能如此重要"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://juejin.im/entry/598080226fb9a03c5d535cd5",target:"_blank",rel:"noopener noreferrer"}},[t._v("Chrome 中的 First Meaningful Paint"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://www.infoq.cn/article/Dxa8aM44oz*Lukk5Ufhy",target:"_blank",rel:"noopener noreferrer"}},[t._v("蚂蚁金服"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://docs.google.com/document/d/1BR94tJdZLsin5poeet0XoTW60M0SjvOJQttKT-JK8HI/view#heading=h.k50nnyhtptq0",target:"_blank",rel:"noopener noreferrer"}},[t._v("FMP"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://www.zhihu.com/question/37585246",target:"_blank",rel:"noopener noreferrer"}},[t._v("如何搭建前端监控体系"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://fex.baidu.com/blog/2014/05/build-performance-monitor-in-7-days/",target:"_blank",rel:"noopener noreferrer"}},[t._v("FEX-7 天打造前端性能监控系统"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://cloud.tencent.com/developer/article/1061844https://segmentfault.com/a/1190000013532766",target:"_blank",rel:"noopener noreferrer"}},[t._v("首屏时间自动化"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://blog.logrocket.com/how-to-practically-use-performance-api-to-measure-performance/Improving",target:"_blank",rel:"noopener noreferrer"}},[t._v("如何使用 performance api 来测量性能"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://www.sitepen.com/blog/improving-performance-with-the-paint-timing-api/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Performance with the Paint Timing API"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/ranyonsue/p/9342839.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("chrome-performance 页面性能分析使用教程"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://help.aliyun.com/document_detail/58652.html?spm=a2c4g.11186623.6.627.7f782f4dsb9ZV7",target:"_blank",rel:"noopener noreferrer"}},[t._v("阿里云前端监控概述"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://webenso.com/forget-page-load-time/",target:"_blank",rel:"noopener noreferrer"}},[t._v("first load 与 first meaningful 的区别"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://cdc.tencent.com/2018/09/13/frontend-exception-monitor-research/",target:"_blank",rel:"noopener noreferrer"}},[t._v("其他"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://juejin.im/post/5dca05f45188250c643b7d76",target:"_blank",rel:"noopener noreferrer"}},[t._v("lightHouse 实现原理"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://michaljanaszek.com/blog/test-website-performance-with-puppeteer",target:"_blank",rel:"noopener noreferrer"}},[t._v("Test website performance with Puppeteer"),e("OutboundLink")],1)])])])])}),[],!1,null,null,null);a.default=n.exports}}]);